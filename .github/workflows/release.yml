name: ðŸ“¦ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  # åˆ›å»ºGitHub Release
  create-release:
    name: ðŸ“ Create Release
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create_release.outputs.id }}
      upload-url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ“‹ Generate changelog
        id: changelog
        run: |
          echo "## ðŸš€ What's New in ${{ steps.version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### âœ¨ Features" >> CHANGELOG.md
          echo "- ðŸ“ å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“åŠŸèƒ½" >> CHANGELOG.md
          echo "- ðŸ“± äºŒç»´ç æ‰«ç ä¸‹è½½" >> CHANGELOG.md
          echo "- ðŸ”„ æœåŠ¡å™¨é‡å¯æ–‡ä»¶æ¢å¤" >> CHANGELOG.md
          echo "- ðŸ“‹ æ–‡ä»¶ç®¡ç†ç•Œé¢" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ› ï¸ Technical" >> CHANGELOG.md
          echo "- Node.js + Express.js åŽç«¯" >> CHANGELOG.md
          echo "- å“åº”å¼å‰ç«¯è®¾è®¡" >> CHANGELOG.md
          echo "- iOS Safari å…¼å®¹æ€§ä¼˜åŒ–" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ“¦ Installation" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "# æºç å®‰è£…" >> CHANGELOG.md
          echo "git clone https://github.com/${{ github.repository }}.git" >> CHANGELOG.md
          echo "cd file-transfer" >> CHANGELOG.md
          echo "npm install && npm start" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md
          
      - name: ðŸš€ Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: ðŸš€ File Transfer ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}

  # åˆ›å»ºéƒ¨ç½²åŒ…
  create-deployment-package:
    name: ðŸ“¦ Create Deployment Package
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          
      - name: ðŸ”§ Install production dependencies
        run: npm install --only=production
        
      - name: ðŸ“ Create deployment structure
        run: |
          mkdir -p deployment/file-transfer
          cp -r public deployment/file-transfer/
          cp server.js package*.json deployment/file-transfer/
          cp -r node_modules deployment/file-transfer/
          cp README.md deployment/file-transfer/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deployment/file-transfer/deploy.sh << 'EOF'
          #!/bin/bash
          echo "ðŸš€ éƒ¨ç½²å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“æœåŠ¡..."
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p uploads
          
          # å®‰è£…ä¾èµ– (å¦‚æžœéœ€è¦)
          if [ ! -d "node_modules" ]; then
            echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --only=production
          fi
          
          # å¯åŠ¨æœåŠ¡
          echo "ðŸŒŸ å¯åŠ¨æœåŠ¡..."
          npm start
          EOF
          
          chmod +x deployment/file-transfer/deploy.sh
        
      - name: ðŸ“¦ Create archive
        run: |
          cd deployment
          tar -czf file-transfer-${{ needs.create-release.outputs.version }}.tar.gz file-transfer/
          zip -r file-transfer-${{ needs.create-release.outputs.version }}.zip file-transfer/
          
      - name: ðŸ“¤ Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: deployment/file-transfer-${{ needs.create-release.outputs.version }}.tar.gz
          asset_name: file-transfer-${{ needs.create-release.outputs.version }}.tar.gz
          asset_content_type: application/gzip
          
      - name: ðŸ“¤ Upload ZIP Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: deployment/file-transfer-${{ needs.create-release.outputs.version }}.zip
          asset_name: file-transfer-${{ needs.create-release.outputs.version }}.zip
          asset_content_type: application/zip

  # å‘å¸ƒé€šçŸ¥
  notify-release:
    name: ðŸ“¢ Release Notification
    runs-on: ubuntu-latest
    needs: [create-release, create-deployment-package]
    if: always()
    
    steps:
      - name: ðŸŽ‰ Success Notification
        if: needs.create-deployment-package.result == 'success'
        run: |
          echo "ðŸŽ‰ å‘å¸ƒæˆåŠŸ!"
          echo "ç‰ˆæœ¬: ${{ needs.create-release.outputs.version }}"
          echo "ðŸ“¦ éƒ¨ç½²åŒ…å·²åˆ›å»º"
          echo ""
          echo "ðŸš€ å¿«é€Ÿå¼€å§‹:"
          echo "ä¸‹è½½éƒ¨ç½²åŒ…ï¼Œè§£åŽ‹åŽè¿è¡Œ ./deploy.sh"
          
      - name: âŒ Failure Notification  
        if: needs.create-deployment-package.result == 'failure'
        run: |
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æž„å»ºæ—¥å¿—"
          exit 1