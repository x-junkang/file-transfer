name: ğŸ“¦ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # åˆ›å»ºGitHub Release
  create-release:
    name: ğŸ“ Create Release
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create_release.outputs.id }}
      upload-url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          echo "## ğŸš€ What's New in ${{ steps.version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### âœ¨ Features" >> CHANGELOG.md
          echo "- ğŸ“ å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“åŠŸèƒ½" >> CHANGELOG.md
          echo "- ğŸ“± äºŒç»´ç æ‰«ç ä¸‹è½½" >> CHANGELOG.md
          echo "- ğŸ”„ æœåŠ¡å™¨é‡å¯æ–‡ä»¶æ¢å¤" >> CHANGELOG.md
          echo "- ğŸ“‹ æ–‡ä»¶ç®¡ç†ç•Œé¢" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ› ï¸ Technical" >> CHANGELOG.md
          echo "- Node.js + Express.js åç«¯" >> CHANGELOG.md
          echo "- å“åº”å¼å‰ç«¯è®¾è®¡" >> CHANGELOG.md
          echo "- Docker å®¹å™¨åŒ–æ”¯æŒ" >> CHANGELOG.md
          echo "- iOS Safari å…¼å®¹æ€§ä¼˜åŒ–" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“¦ Installation" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "# Docker æ–¹å¼" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> CHANGELOG.md
          echo "docker run -p 3000:3000 ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# æºç æ–¹å¼" >> CHANGELOG.md
          echo "git clone https://github.com/${{ github.repository }}.git" >> CHANGELOG.md
          echo "cd file-transfer" >> CHANGELOG.md
          echo "npm install && npm start" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md
          
      - name: ğŸš€ Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: ğŸš€ File Transfer ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}

  # æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  build-and-push-image:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # åˆ›å»ºéƒ¨ç½²åŒ…
  create-deployment-package:
    name: ğŸ“¦ Create Deployment Package
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ğŸ”§ Install production dependencies
        run: npm ci --only=production
        
      - name: ğŸ“ Create deployment structure
        run: |
          mkdir -p deployment/file-transfer
          cp -r public deployment/file-transfer/
          cp server.js package*.json deployment/file-transfer/
          cp -r node_modules deployment/file-transfer/
          cp Dockerfile deployment/file-transfer/
          cp README.md deployment/file-transfer/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deployment/file-transfer/deploy.sh << 'EOF'
          #!/bin/bash
          echo "ğŸš€ éƒ¨ç½²å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“æœåŠ¡..."
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p uploads
          
          # å®‰è£…ä¾èµ– (å¦‚æœéœ€è¦)
          if [ ! -d "node_modules" ]; then
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --only=production
          fi
          
          # å¯åŠ¨æœåŠ¡
          echo "ğŸŒŸ å¯åŠ¨æœåŠ¡..."
          npm start
          EOF
          
          chmod +x deployment/file-transfer/deploy.sh
          
          # åˆ›å»ºDockeréƒ¨ç½²è„šæœ¬
          cat > deployment/file-transfer/docker-deploy.sh << 'EOF'
          #!/bin/bash
          echo "ğŸ³ ä½¿ç”¨Dockeréƒ¨ç½²..."
          
          # æ„å»ºé•œåƒ
          docker build -t file-transfer .
          
          # åœæ­¢ç°æœ‰å®¹å™¨
          docker stop file-transfer 2>/dev/null || true
          docker rm file-transfer 2>/dev/null || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name file-transfer \
            -p 3000:3000 \
            -v $(pwd)/uploads:/app/uploads \
            file-transfer
            
          echo "âœ… éƒ¨ç½²å®Œæˆ! è®¿é—® http://localhost:3000"
          EOF
          
          chmod +x deployment/file-transfer/docker-deploy.sh
        
      - name: ğŸ“¦ Create archive
        run: |
          cd deployment
          tar -czf file-transfer-${{ needs.create-release.outputs.version }}.tar.gz file-transfer/
          zip -r file-transfer-${{ needs.create-release.outputs.version }}.zip file-transfer/
          
      - name: ğŸ“¤ Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: deployment/file-transfer-${{ needs.create-release.outputs.version }}.tar.gz
          asset_name: file-transfer-${{ needs.create-release.outputs.version }}.tar.gz
          asset_content_type: application/gzip
          
      - name: ğŸ“¤ Upload ZIP Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: deployment/file-transfer-${{ needs.create-release.outputs.version }}.zip
          asset_name: file-transfer-${{ needs.create-release.outputs.version }}.zip
          asset_content_type: application/zip

  # å‘å¸ƒé€šçŸ¥
  notify-release:
    name: ğŸ“¢ Release Notification
    runs-on: ubuntu-latest
    needs: [create-release, build-and-push-image, create-deployment-package]
    if: always()
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.build-and-push-image.result == 'success' && needs.create-deployment-package.result == 'success'
        run: |
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸ!"
          echo "ç‰ˆæœ¬: ${{ needs.create-release.outputs.version }}"
          echo "ğŸ³ Dockeré•œåƒ: ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}"
          echo "ğŸ“¦ éƒ¨ç½²åŒ…å·²åˆ›å»º"
          echo ""
          echo "ğŸš€ å¿«é€Ÿå¼€å§‹:"
          echo "docker run -p 3000:3000 ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}"
          
      - name: âŒ Failure Notification  
        if: needs.build-and-push-image.result == 'failure' || needs.create-deployment-package.result == 'failure'
        run: |
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
          exit 1